# Spring Boot (Week 8) - JPA 연관관계 & ERD 설계 가이드

## 객체지향과 관계형 DB의 연관관계 차이

| 개념 | 객체 지향 프로그래밍 | 관계형 데이터베이스 |
|------|--------------------|--------------------|
| 관계 표현 방식 | 참조 필드를 통해 객체 간 연결 | 외래키(FK)를 통해 테이블 간 연결 |
| 방향성 개념 | 존재함 (단방향/양방향) | 없음 (양방향 조인 가능) |
| 연결 구조 | 객체 = 메모리 상 연결 | 테이블 = 스키마 기반 참조 |

➡️ 서로 다른 모델을 자연스럽게 연결하기 위해 **ORM (Object Relational Mapping)** 기술 사용

---

## 연관관계 구성 요소

### 1. 관계 방향 (Direction)
- **단방향**: 한 쪽만 참조 필드를 가짐 (`Member → Team`)
- **양방향**: 양쪽 모두 참조 필드 가짐 (`Member ↔ Team`)
    - 양방향 관계에서는 반드시 **연관관계의 주인**을 지정해야 함

### 2. 연관관계 주인 (Owner)
- **주인(Owner)**: 외래키 관리 가능, `mappedBy` 사용 ❌
- **비주인(Inverse)**: 외래키 관리 불가, `mappedBy` 사용 ⭕

> 💡 외래키가 존재하는 쪽이 보통 연관관계의 주인이 됨

### 3. 다중성 (Multiplicity)

| 형태 | 어노테이션 | 예시 설명 |
|------|------------|-----------|
| 다대일 (N:1) | `@ManyToOne` | 여러 멤버가 하나의 팀에 속함 |
| 일대다 (1:N) | `@OneToMany` | 한 팀이 여러 멤버를 가짐 |
| 일대일 (1:1) | `@OneToOne` | 한 사람 ↔ 하나의 여권 |
| 다대다 (N:M) | `@ManyToMany` | 여러 게시글 ↔ 여러 태그 (중간 테이블 필요) |

> ⚠️ RDB는 직접적인 N:M 관계를 허용하지 않음 → 반드시 중간 조인 테이블 필요

---

## Fetch 전략 (즉시 vs 지연 로딩)

JPA에서 연관된 엔티티를 어떻게 가져올지 결정하는 방식

### 즉시 로딩 (EAGER)
- **특징**: 엔티티 조회 시 연관 객체도 함께 조회됨
- **장점**: 사용 편리
- **단점**: 성능 저하 가능성 (불필요한 조인 발생)

```java
@ManyToOne(fetch = FetchType.EAGER)
@JoinColumn(name = "team_id")
private Team team;
```

### 지연 로딩 (LAZY)
- **특징**: 실제 사용하는 시점에만 조회 (프록시 객체)
- **장점**: 성능 향상, 최소 쿼리
- **단점**: 사용 시점에 N+1 문제 발생할 수 있음

```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "team_id")
private Team team;
```

> 💡 기본값: `@ManyToOne`은 EAGER, `@OneToMany`는 LAZY

---

## Cascade (영속성 전이)

부모 엔티티의 작업이 자식 엔티티에게도 자동으로 전파됨

| 타입 | 설명 |
|------|------|
| `ALL` | 모든 영속성 전이 포함 |
| `PERSIST` | 부모 저장 시 자식도 저장 |
| `MERGE` | 부모 병합 시 자식도 병합 |
| `REMOVE` | 부모 삭제 시 자식도 삭제 |
| `REFRESH` | 부모 새로고침 시 자식도 새로고침 |
| `DETACH` | 부모 영속성 분리 시 자식도 분리됨 |

### orphanRemoval
- 부모 객체와의 관계가 끊긴 **고아 객체**를 자동 삭제
- 데이터 정합성을 유지하는 데 유용

---

## ERD(Entity Relationship Diagram)

### 개념
- 데이터베이스 테이블 간의 관계를 시각적으로 표현한 다이어그램
- ERD는 논리적 모델(개념 중심)과 물리적 모델(DB 제약조건 포함)로 구분

### 도구
- **MySQL Workbench**: 로컬 설치, ERD 작성 + SQL 실행
- **ERD Cloud**: 웹 기반, 실시간 협업, SQL 생성

---

## 관계 유형: 식별 vs 비식별

| 유형 | 설명 |
|------|------|
| **식별관계 (Identifying)** | 부모의 기본키가 자식의 기본키로 사용됨 |
| **비식별관계 (Non-Identifying)** | 부모의 기본키가 자식의 외래키로 사용됨 |

> 💡 비식별 관계가 더 일반적이며 유연하게 설계 가능

---

## 설계 시 실수 방지 체크리스트
- [ ] 모든 테이블에 **Primary Key** 설정
- [ ] 외래키 참조 무결성 보장 (`ON DELETE` 옵션 확인)
- [ ] N:M 관계는 반드시 중간 테이블로 분해
- [ ] 지연 로딩 기본값과 실제 사용 시점 고려
- [ ] Cascade 옵션과 orphanRemoval의 영향 명확히 파악


---


# ‼️ ERD 작성 시 주의해야 할 제약조건

ERD(Entity Relationship Diagram)를 작성할 때 고려해야 할 **제약조건(Constraints)**은 데이터 무결성과 일관성을 유지하기 위해 필수적인 요소입니다.

---

## 주요 제약조건 종류

### 1. Primary Key (기본 키)
- 각 테이블의 **행(row)**을 고유하게 식별
- `NULL 불가`, `중복 불가`
- ERD 상에서는 **밑줄로 표시**

**예시**: `user_id`, `product_id`

**주의사항**:
- 모든 테이블은 기본키가 반드시 있어야 함
- 복합키 사용 시 조합이 유일해야 함

---

### 2. Foreign Key (외래 키)
- 다른 테이블의 **기본키**를 참조하여 관계 형성
- 참조 무결성 유지

**주의사항**:
- 참조 대상 테이블에 값이 존재해야 함
- `ON DELETE`, `ON UPDATE` 설정 고려

| 옵션         | 설명                                      |
|--------------|-------------------------------------------|
| `CASCADE`    | 부모 삭제 시 자식도 함께 삭제             |
| `SET NULL`   | 부모 삭제 시 자식 외래키를 NULL로 설정    |
| `RESTRICT`   | 참조 중이면 삭제/수정 제한                |

---

### 3. Unique (유일 제약조건)
- 특정 컬럼의 **값이 중복되면 안 됨**

**예시**: 이메일, 주민등록번호 등

**주의사항**:
- `NULL`은 허용될 수 있음 (기본키와의 차이점)

---

### 4. Not Null
- 컬럼에 반드시 **값이 있어야 함**

**예시**: 사용자 이름, 이메일 등 필수값

**주의사항**:
- 비즈니스 상 꼭 필요한 필드에 설정

---

### 5. Check
- **입력값의 조건**을 제한

**예시**:
```sql
age INT CHECK (age >= 0)
gender CHAR(1) CHECK (gender IN ('M', 'F'))
```

**주의사항**:
- 간단한 검증 용도로만 사용 권장

---

### 6. Default
- 값이 주어지지 않았을 때 자동으로 입력할 **기본값**

**예시**:
```sql
status VARCHAR(10) DEFAULT 'active'
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

---

### 7. Composite Key (복합키)
- 여러 컬럼을 조합하여 기본키로 설정

**예시**: `user_id + role_id`

**주의사항**:
- 중간 테이블(다대다 관계 표현)에서 자주 사용

---

## ERD 설계 팁

- **정규화**로 중복 데이터 방지
- 테이블 간 관계를 명확히 정의 (1:1, 1:N, N:M 등)
- 논리 ERD → 구조 설계 중심
- 물리 ERD → 실제 제약조건 반영

---

## ERD 도구 예시
- **MySQL Workbench**: GUI 기반, ERD 생성 및 쿼리 실행
- **ERD Cloud**: 웹 기반, 설치 필요 없음, SQL 추출 및 협업 기능

